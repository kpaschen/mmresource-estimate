- name: install tools
  apt:
     pkg:
     - git
     - golang
     - default-jre
     state: latest
     update_cache: true

- name: see if loadtest repo already exists
  stat:
     path: ./mattermost-load-test-ng
  register: gitrepo_exists

- name: print gitrepo check
  debug:
     msg: "{{ gitrepo_exists }}"

- name:  clone the loadtest repository
  shell:
     cmd: git clone https://github.com/mattermost/mattermost-load-test-ng
  when: gitrepo_exists.stat.exists == false

- name: copy config file
  copy:
     src: mattermost-load-test-ng/config/config.sample.json
     dest: mattermost-load-test-ng/config/config.json 
     mode: u=rw,g=r,o=r
     remote_src: yes

- name: adapt serverurl 
  ansible.builtin.lineinfile:
     path: mattermost-load-test-ng/config/config.json
     regexp: '"ServerURL"'
     line: '     "ServerURL": "http://{{mm_private_ip}}:80",' 

- name: adapt websocketurl 
  ansible.builtin.lineinfile:
     path: mattermost-load-test-ng/config/config.json
     regexp: '"WebSocketURL"'
     line: '     "WebSocketURL": "ws://{{mm_private_ip}}:80",' 

- name: adapt adminemail 
  ansible.builtin.lineinfile:
     path: mattermost-load-test-ng/config/config.json
     regexp: '"AdminEmail"'
     line: '     "AdminEmail": "x@y.com",'

- name: adapt adminpwd 
  ansible.builtin.lineinfile:
     path: mattermost-load-test-ng/config/config.json
     regexp: '"AdminPassword"'
     line: '     "AdminPassword": "{{ mm_admin_password }}"'

- name: copy simplecontroller file
  copy:
     src: mattermost-load-test-ng/config/simplecontroller.sample.json
     dest: mattermost-load-test-ng/config/simplecontroller.json 
     mode: u=rw,g=r,o=r
     remote_src: yes

- name: run ltagent init in order to download all the go dependencies
  shell:
     chdir: /home/ubuntu/mattermost-load-test-ng
     cmd: go run ./cmd/ltagent init

- name: change ownership of the loadtest files to ubuntu
  file:
     path: /home/ubuntu/mattermost-load-test-ng
     owner: ubuntu
     group: ubuntu
     recurse: yes

